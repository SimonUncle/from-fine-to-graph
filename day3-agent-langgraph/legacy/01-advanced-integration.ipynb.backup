{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "ce461b29",
   "metadata": {},
   "source": [
    "# 01 Â· LangGraph Advanced Integration (Prerequisite)\n",
    "\n",
    "í”„ë¦¬ ì„¸ì…˜ì—ì„œ ê°•ì‚¬ê°€ ë‹¨ê³„ë³„ë¡œ ì‹œì—°í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë²„ì „ì…ë‹ˆë‹¤. ê° ë‹¨ê³„ì˜ ì¶œë ¥ê³¼ ì„¤ëª…ì„ í•™ìŠµìì—ê²Œ ë³´ì—¬ì£¼ê³ , ì´í›„ ë©”ì¸ ì‹¤ìŠµì—ì„œ ë™ì¼í•œ êµ¬ì¡°ë¥¼ ì§ì ‘ êµ¬í˜„í•˜ê²Œ ì•ˆë‚´í•˜ì„¸ìš”."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7fa12e6d",
   "metadata": {},
   "source": [
    "## Step 0. í™˜ê²½ ì¤€ë¹„\n",
    "1. ì˜ì¡´ì„± ì„¤ì¹˜ê°€ í•„ìš”í•˜ë©´ ì•„ë˜ `pip` ì…€ì„ ì‹¤í–‰í•˜ì„¸ìš”. (ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´ ê±´ë„ˆëœë‹ˆë‹¤.)\n",
    "2. ì´ì–´ì§€ëŠ” import ì…€ì„ ë°˜ë“œì‹œ ì‹¤í–‰í•´ì•¼ ì´í›„ ì½”ë“œì—ì„œ íƒ€ì…ê³¼ ìœ í‹¸ í•¨ìˆ˜ë¥¼ ì¸ì‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "19ff2811",
   "metadata": {},
   "outputs": [],
   "source": [
    "# %pip install -q langgraph langchain langchain-teddynote"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ebb2ff66",
   "metadata": {},
   "outputs": [],
   "source": [
    "from typing import TypedDict, Dict, List, Annotated\n",
    "\n",
    "from langgraph.graph import StateGraph, START, END\n",
    "from langgraph.types import Command, interrupt\n",
    "from langgraph.checkpoint.memory import MemorySaver\n",
    "from langchain_core.messages import HumanMessage, AIMessage\n",
    "from langchain_teddynote.graphs import visualize_graph\n",
    "from langchain_teddynote.messages import stream_graph\n",
    "import operator\n",
    "\n",
    "\n",
    "def apply_update(state: Dict, update: Dict) -> Dict:\n",
    "    \"\"\"LangGraph ë…¸ë“œê°€ ë°˜í™˜í•œ update ë”•ì…”ë„ˆë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìƒíƒœì— ë°˜ì˜.\"\"\"\n",
    "    new_state = state.copy()\n",
    "    for key, value in update.items():\n",
    "        if key == 'audit_log':\n",
    "            new_state[key] = [*state.get(key, []), *value]\n",
    "        else:\n",
    "            new_state[key] = value\n",
    "    return new_state\n",
    "\n",
    "\n",
    "def pretty_print_state(state: Dict, title: str) -> None:\n",
    "    \"\"\"ì—°ìŠµ ë‹¨ê³„ì—ì„œ ìƒíƒœ ë‚´ìš©ì„ ë³´ê¸° ì‰½ê²Œ ì¶œë ¥.\"\"\"\n",
    "    print(f'[{title}]')\n",
    "    for key, value in state.items():\n",
    "        print(f'- {key}: {value}')\n",
    "    print()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "39057be3",
   "metadata": {},
   "source": [
    "### ì°¸ê³ : ì—°ìŠµìš© í—¬í¼ í•¨ìˆ˜\n",
    "- **`apply_update`**: LangGraphê°€ ë°˜í™˜í•œ `dict` ì—…ë°ì´íŠ¸ ê²°ê³¼ë¥¼ í˜„ì¬ ìƒíƒœì— ìˆ˜ë™ìœ¼ë¡œ ì ìš©í•©ë‹ˆë‹¤.\n",
    "- **`pretty_print_state`**: ìƒíƒœ ê°ì²´ì˜ í•„ë“œ ê°’ì„ ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥í•´ ì–´ë–¤ í‚¤ê°€ ì–¸ì œ ì±„ì›Œì§€ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆê²Œ ë•ìŠµë‹ˆë‹¤.\n",
    "\n",
    "> ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” LangGraphê°€ ë‚´ë¶€ì ìœ¼ë¡œ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ì§€ë§Œ, ì—°ìŠµ ë‹¨ê³„ì—ì„œëŠ” ì´ ë‘ í—¬í¼ë¥¼ ì‚¬ìš©í•´ \"ë…¸ë“œ ì‹¤í–‰ ì „í›„ ìƒíƒœ ë³€í™”\"ë¥¼ ëª…í™•íˆ ê´€ì°°í•©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2df15a9e",
   "metadata": {},
   "source": [
    "## Step 1. ìƒíƒœ(State) ì„¤ê³„\n",
    "LangGraphëŠ” ë…¸ë“œ ê°„ì— ê³µí†µ ìƒíƒœë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤. `TypedDict`ë¡œ í•„ë“œë¥¼ ì •ì˜í•´ ì–´ë–¤ ì •ë³´ê°€ íë¥´ëŠ”ì§€ ëª…í™•íˆ í•©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "aea39c70",
   "metadata": {},
   "outputs": [],
   "source": [
    "class IntegratedState(TypedDict):\n",
    "    customer_query: str\n",
    "    category: str\n",
    "    technical_report: str\n",
    "    policy_report: str\n",
    "    service_report: str\n",
    "    draft_response: str\n",
    "    final_response: str\n",
    "    review_feedback: str\n",
    "    approval_status: str\n",
    "    audit_log: Annotated[List[str], operator.add]\n",
    "\n",
    "\n",
    "def initial_state(query: str) -> IntegratedState:\n",
    "    return IntegratedState(\n",
    "        customer_query=query,\n",
    "        category='',\n",
    "        technical_report='',\n",
    "        policy_report='',\n",
    "        service_report='',\n",
    "        draft_response='',\n",
    "        final_response='',\n",
    "        review_feedback='',\n",
    "        approval_status='pending',\n",
    "        audit_log=[],\n",
    "    )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "91a5ea93",
   "metadata": {},
   "outputs": [],
   "source": [
    "example_state = initial_state('ì¶©ì „ê¸°ê°€ ê³ ì¥ë‚˜ì„œ ë„ì›€ì´ í•„ìš”í•´ìš”')\n",
    "pretty_print_state(example_state, 'ì´ˆê¸° ìƒíƒœ')"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ea7238c1",
   "metadata": {},
   "source": [
    "## Step 2. ë¼ìš°íŒ… ë¡œì§\n",
    "- ì˜ì–´/í•œêµ­ì–´ í‚¤ì›Œë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¬¸ì˜ ìœ í˜•ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤. (ì˜ˆ: `ê³ ì¥` â†’ ê¸°ìˆ íŒ€, `í™˜ë¶ˆ` â†’ ì •ì±…íŒ€)\n",
    "- í•¨ìˆ˜ê°€ ë°˜í™˜í•˜ëŠ” `Command`ì—ëŠ” **ë‹¤ìŒì— ì‹¤í–‰í•  ë…¸ë“œ ì´ë¦„**ê³¼ **ìƒíƒœ ì—…ë°ì´íŠ¸ ì •ë³´**ê°€ ë“¤ì–´ ìˆìŠµë‹ˆë‹¤.\n",
    "- ì•„ë˜ ì…€ì—ì„œ ì„œë¡œ ë‹¤ë¥¸ ì…ë ¥ì„ ë„£ì–´ ì–´ëŠ íŒ€ìœ¼ë¡œ ë¶„ê¸°ê°€ ë˜ëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f6fb998b",
   "metadata": {},
   "outputs": [],
   "source": [
    "TECH_KEYWORDS = ('error', 'fault', 'broken', 'issue', 'ê³ ì¥')\n",
    "POLICY_KEYWORDS = ('refund', 'policy', 'regulation', 'cancel', 'í™˜ë¶ˆ')\n",
    "\n",
    "\n",
    "def categorize(query: str) -> str:\n",
    "    lower = query.lower()\n",
    "    if any(word in lower for word in POLICY_KEYWORDS):\n",
    "        return 'policy'\n",
    "    if any(word in lower for word in TECH_KEYWORDS):\n",
    "        return 'technical'\n",
    "    return 'service'\n",
    "\n",
    "\n",
    "def router_node(state: IntegratedState) -> Command:\n",
    "    category = categorize(state['customer_query'])\n",
    "    target = (\n",
    "        'technical_team' if category == 'technical'\n",
    "        else 'policy_team' if category == 'policy'\n",
    "        else 'service_team'\n",
    "    )\n",
    "    return Command(\n",
    "        goto=target,\n",
    "        update={\n",
    "            'category': category,\n",
    "            'audit_log': [f'ë¼ìš°í„°: {category} ì„ íƒ'],\n",
    "        },\n",
    "    )\n",
    "\n",
    "router_graph = StateGraph(IntegratedState)\n",
    "router_graph.add_node('router', router_node)\n",
    "router_graph.add_edge(START, 'router')\n",
    "router_graph.add_edge('router', END)\n",
    "router_app = router_graph.compile()\n",
    "\n",
    "print('ğŸ“Š ë¼ìš°íŒ… ê·¸ë˜í”„')\n",
    "visualize_graph(router_app)\n",
    "\n",
    "for query in ['ì¶©ì „ê¸°ê°€ ê³ ì¥ë‚¬ì–´ìš”', 'í™˜ë¶ˆì´ ì•„ì§ ì²˜ë¦¬ ì•ˆ ëì–´ìš”', 'ìƒë‹´ì›ì„ ì—°ê²°í•˜ê³  ì‹¶ì–´ìš”']:\n",
    "    result = router_app.invoke(initial_state(query))\n",
    "    print(f'ë¬¸ì˜: {query}')\n",
    "    print(f\"- category: {result['category']}\")\n",
    "    print(f\"- audit_log: {result['audit_log']}\")\n",
    "    print()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4b9d7f11",
   "metadata": {},
   "source": [
    "## Step 3. ì „ë¬¸ íŒ€ ë…¸ë“œ\n",
    "- ê° íŒ€ì€ ìì‹ ì˜ ê´€ì ì—ì„œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ê³  `audit_log`ì— ì§„í–‰ ìƒí™©ì„ ë‚¨ê¹ë‹ˆë‹¤.\n",
    "- ì•„ë˜ ì…€ì—ì„œëŠ” ë¼ìš°í„°ê°€ ì„ íƒí•œ íŒ€ ë…¸ë“œë§Œ ì‹¤í–‰í•´ ì‹¤ì œ ì›Œí¬í”Œë¡œìš°ì˜ íë¦„ì„ ì¬í˜„í•©ë‹ˆë‹¤.\n",
    "- ì´í›„ Step 4ì—ì„œ ì„¸ íŒ€ ì¶œë ¥ì„ ëª¨ë‘ í•©ì³ ì´ˆì•ˆì„ ë§Œë“­ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "25851cec",
   "metadata": {},
   "outputs": [],
   "source": [
    "def build_report(lines: List[str]) -> str:\n",
    "    return '\\n'.join(lines)\n",
    "\n",
    "\n",
    "def technical_team_node(state: IntegratedState) -> Dict:\n",
    "    lines = [\n",
    "        '[ê¸°ìˆ íŒ€ ìš”ì•½]',\n",
    "        f\"- ë¬¸ì œ: {state['customer_query']}\",\n",
    "        '- ì¡°ì¹˜: ì „ì› ì¬ì—°ê²°, íŒì›¨ì–´ ìµœì‹ í™”, í•˜ë“œì›¨ì–´ ì´ìƒ ì—¬ë¶€ë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤.',\n",
    "    ]\n",
    "    return {\n",
    "        'technical_report': build_report(lines),\n",
    "        'audit_log': ['ê¸°ìˆ íŒ€ ë³´ê³ ì„œ ì‘ì„±'],\n",
    "    }\n",
    "\n",
    "\n",
    "def policy_team_node(state: IntegratedState) -> Dict:\n",
    "    lines = [\n",
    "        '[ì •ì±…íŒ€ ìš”ì•½]',\n",
    "        f\"- ë¬¸ì˜: {state['customer_query']}\",\n",
    "        '- ì¡°ì¹˜: í™˜ë¶ˆ/êµí™˜ ê¸°ì¤€ ê²€í†  ë° ì¶”ê°€ ì¦ë¹™ ìš”ì²­ ì ˆì°¨ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.',\n",
    "    ]\n",
    "    return {\n",
    "        'policy_report': build_report(lines),\n",
    "        'audit_log': ['ì •ì±…íŒ€ ë³´ê³ ì„œ ì‘ì„±'],\n",
    "    }\n",
    "\n",
    "\n",
    "def service_team_node(state: IntegratedState) -> Dict:\n",
    "    lines = [\n",
    "        '[ì„œë¹„ìŠ¤íŒ€ ìš”ì•½]',\n",
    "        '- ê³µê° í‘œí˜„: ë¶ˆí¸ì„ ë“œë¦° ì ì— ëŒ€í•´ ì§„ì‹¬ìœ¼ë¡œ ì‚¬ê³¼ë“œë¦½ë‹ˆë‹¤.',\n",
    "        '- í›„ì† ì§€ì›: 24ì‹œê°„ ìƒë‹´ ì±„ë„ê³¼ ì¶”ê°€ ë³´ìƒ ë°©ì•ˆì„ ì•ˆë‚´í•©ë‹ˆë‹¤.',\n",
    "    ]\n",
    "    return {\n",
    "        'service_report': build_report(lines),\n",
    "        'audit_log': ['ì„œë¹„ìŠ¤íŒ€ ë³´ê³ ì„œ ì‘ì„±'],\n",
    "    }\n",
    "\n",
    "team_graph = StateGraph(IntegratedState)\n",
    "team_graph.add_node('router', router_node)\n",
    "team_graph.add_node('technical_team', technical_team_node)\n",
    "team_graph.add_node('policy_team', policy_team_node)\n",
    "team_graph.add_node('service_team', service_team_node)\n",
    "team_graph.add_edge(START, 'router')\n",
    "team_graph.add_edge('router', 'technical_team')\n",
    "team_graph.add_edge('router', 'policy_team')\n",
    "team_graph.add_edge('router', 'service_team')\n",
    "team_graph.add_edge('technical_team', END)\n",
    "team_graph.add_edge('policy_team', END)\n",
    "team_graph.add_edge('service_team', END)\n",
    "team_app = team_graph.compile()\n",
    "\n",
    "print('ğŸ“Š íŒ€ ë…¸ë“œ ê·¸ë˜í”„')\n",
    "visualize_graph(team_app)\n",
    "\n",
    "for query in ['ì¶©ì „ê¸°ê°€ ê³ ì¥ë‚˜ì„œ ë„ì›€ì´ í•„ìš”í•´ìš”', 'ì–´ì œ í™˜ë¶ˆì„ ìš”ì²­í–ˆëŠ”ë° ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ì–´ìš”.']:\n",
    "    result = team_app.invoke(initial_state(query))\n",
    "    pretty_print_state(result, f\"íŒ€ ë…¸ë“œ ì‹¤í–‰ ê²°ê³¼ - {result['category']}\")\n",
    "print('â€» Step 4ì—ì„œëŠ” ì„¸ íŒ€ ë…¸ë“œ ì¶œë ¥ì„ ëª¨ë‘ í•©ì³ Fan-in ë™ì‘ì„ í™•ì¸í•©ë‹ˆë‹¤.')"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "27a7a230",
   "metadata": {},
   "source": [
    "## Step 4. Fan-inìœ¼ë¡œ ì´ˆì•ˆ ë§Œë“¤ê¸°\n",
    "- ê° íŒ€ì˜ ë³´ê³ ì„œë¥¼ ëª¨ë‘ ëª¨ì•„ í•˜ë‚˜ì˜ ì´ˆì•ˆ ì‘ë‹µì„ ë§Œë“­ë‹ˆë‹¤.\n",
    "- ì•„ë˜ ì…€ì—ì„œëŠ” ì—°ìŠµì„ ìœ„í•´ ì„¸ íŒ€ ë…¸ë“œë¥¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•œ ë’¤ `fan_in_node`ë¥¼ ì ìš©í•©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fc8a8c62",
   "metadata": {},
   "outputs": [],
   "source": [
    "def fan_in_node(state: IntegratedState) -> Dict:\n",
    "    parts = [\n",
    "        '[ê³ ê° ì‘ëŒ€ ì´ˆì•ˆ]',\n",
    "        state['technical_report'] or '(ê¸°ìˆ íŒ€ í•´ë‹¹ ì—†ìŒ)',\n",
    "        state['policy_report'] or '(ì •ì±…íŒ€ í•´ë‹¹ ì—†ìŒ)',\n",
    "        state['service_report'] or '(ì„œë¹„ìŠ¤íŒ€ í•´ë‹¹ ì—†ìŒ)',\n",
    "    ]\n",
    "    return {\n",
    "        'draft_response': '\\n\\n'.join(parts),\n",
    "        'audit_log': ['ì´ˆì•ˆ ì‘ë‹µ ì‘ì„±'],\n",
    "    }\n",
    "\n",
    "fan_graph = StateGraph(IntegratedState)\n",
    "fan_graph.add_node('technical_team', technical_team_node)\n",
    "fan_graph.add_node('policy_team', policy_team_node)\n",
    "fan_graph.add_node('service_team', service_team_node)\n",
    "fan_graph.add_node('fan_in', fan_in_node)\n",
    "fan_graph.add_edge(START, 'technical_team')\n",
    "fan_graph.add_edge('technical_team', 'policy_team')\n",
    "fan_graph.add_edge('policy_team', 'service_team')\n",
    "fan_graph.add_edge('service_team', 'fan_in')\n",
    "fan_graph.add_edge('fan_in', END)\n",
    "fan_app = fan_graph.compile()\n",
    "\n",
    "print('ğŸ“Š Fan-in ë°ëª¨ ê·¸ë˜í”„')\n",
    "visualize_graph(fan_app)\n",
    "\n",
    "fan_result = fan_app.invoke(initial_state('ì¶©ì „ê¸°ê°€ ê³ ì¥ë‚˜ì„œ ë„ì›€ì´ í•„ìš”í•´ìš”'))\n",
    "print(fan_result['draft_response'])\n",
    "print('\n",
    "ì‹¤í–‰ ë¡œê·¸:', fan_result['audit_log'])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "75279e04",
   "metadata": {},
   "source": [
    "## Step 5. í’ˆì§ˆ ê°€ë“œ & ì¸ê°„ ê²€í†  ë…¸ë“œ\n",
    "- ì •ì±… ì´ìŠˆ(`category == \"policy\"`)ëŠ” `interrupt()`ë¥¼ í†µí•´ ì¸ê°„ ê²€í† ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.\n",
    "- ìë™ ìŠ¹ì¸ ì¼€ì´ìŠ¤(ê¸°ìˆ /ì„œë¹„ìŠ¤)ëŠ” ì¦‰ì‹œ `writer_signoff`ë¡œ ì´ë™í•©ë‹ˆë‹¤.\n",
    "- ì•„ë˜ ì…€ì€ ë‘ ê²½ë¡œ(ìë™ ìŠ¹ì¸ / ì¸ê°„ ê²€í† )ë¥¼ ëª¨ë‘ ì‹¤ìŠµí•©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5e1110f6",
   "metadata": {},
   "outputs": [],
   "source": [
    "def quality_gate_node(state: IntegratedState) -> Command:\n",
    "    if state['category'] == 'policy':\n",
    "        feedback = interrupt({\n",
    "            'title': 'ì •ì±… ê²€í†  í•„ìš”',\n",
    "            'draft': state['draft_response'],\n",
    "            'instruction': 'ê²€í†  ì˜ê²¬ì„ ì…ë ¥í•˜ë©´ ì›Œí¬í”Œë¡œìš°ê°€ ì¬ê°œë©ë‹ˆë‹¤.',\n",
    "        })\n",
    "        return Command(\n",
    "            goto='human_review',\n",
    "            update={\n",
    "                'review_feedback': feedback,\n",
    "                'audit_log': ['ì¸ê°„ ê²€í†  ìš”ì²­'],\n",
    "            },\n",
    "        )\n",
    "    return Command(\n",
    "        goto='writer_signoff',\n",
    "        update={\n",
    "            'final_response': state['draft_response'],\n",
    "            'approval_status': 'auto',\n",
    "            'audit_log': ['í’ˆì§ˆ ê°€ë“œ í†µê³¼'],\n",
    "        },\n",
    "    )\n",
    "\n",
    "\n",
    "def human_review_node(state: IntegratedState) -> Dict:\n",
    "    final = '\\n\\n'.join([state['draft_response'], '[ê²€í† ì ë©”ëª¨]', state['review_feedback']])\n",
    "    return {\n",
    "        'final_response': final,\n",
    "        'approval_status': 'approved',\n",
    "        'audit_log': ['ê²€í†  í”¼ë“œë°± ë°˜ì˜'],\n",
    "    }\n",
    "\n",
    "\n",
    "def writer_signoff_node(state: IntegratedState) -> Dict:\n",
    "    return {\n",
    "        'audit_log': ['ìµœì¢… ì‚¬ì¸ì˜¤í”„'],\n",
    "    }\n",
    "\n",
    "# ìë™ ìŠ¹ì¸ ê²½ë¡œ ê·¸ë¦¬ê¸°\n",
    "auto_quality_graph = StateGraph(IntegratedState)\n",
    "auto_quality_graph.add_node('fan_in', fan_in_node)\n",
    "auto_quality_graph.add_node('quality_gate', quality_gate_node)\n",
    "auto_quality_graph.add_node('writer_signoff', writer_signoff_node)\n",
    "auto_quality_graph.add_edge(START, 'fan_in')\n",
    "auto_quality_graph.add_edge('fan_in', 'quality_gate')\n",
    "auto_quality_graph.add_edge('quality_gate', 'writer_signoff')\n",
    "auto_quality_graph.add_edge('writer_signoff', END)\n",
    "auto_quality_app = auto_quality_graph.compile()\n",
    "\n",
    "print('ğŸ“Š í’ˆì§ˆ ê°€ë“œ ê·¸ë˜í”„ (ìë™ ìŠ¹ì¸)')\n",
    "visualize_graph(auto_quality_app)\n",
    "\n",
    "auto_result = auto_quality_app.invoke(initial_state('ì¶©ì „ê¸°ê°€ ê³ ì¥ë‚˜ì„œ ë„ì›€ì´ í•„ìš”í•´ìš”'))\n",
    "print('[ìë™ ìŠ¹ì¸ ê²½ë¡œ]')\n",
    "print(auto_result['final_response'])\n",
    "print('ì‹¤í–‰ ë¡œê·¸:', auto_result['audit_log'])\n",
    "\n",
    "# ì¸ê°„ ê²€í†  ê²½ë¡œ ê·¸ë¦¬ê¸°\n",
    "policy_quality_graph = StateGraph(IntegratedState)\n",
    "policy_quality_graph.add_node('fan_in', fan_in_node)\n",
    "policy_quality_graph.add_node('quality_gate', quality_gate_node)\n",
    "policy_quality_graph.add_node('human_review', human_review_node)\n",
    "policy_quality_graph.add_node('writer_signoff', writer_signoff_node)\n",
    "policy_quality_graph.add_edge(START, 'fan_in')\n",
    "policy_quality_graph.add_edge('fan_in', 'quality_gate')\n",
    "policy_quality_graph.add_edge('quality_gate', 'human_review')\n",
    "policy_quality_graph.add_edge('quality_gate', 'writer_signoff')\n",
    "policy_quality_graph.add_edge('human_review', 'writer_signoff')\n",
    "policy_quality_graph.add_edge('writer_signoff', END)\n",
    "policy_quality_app = policy_quality_graph.compile()\n",
    "\n",
    "print('\n",
    "ğŸ“Š í’ˆì§ˆ ê°€ë“œ ê·¸ë˜í”„ (ì¸ê°„ ê²€í† )')\n",
    "visualize_graph(policy_quality_app)\n",
    "\n",
    "policy_config = {'configurable': {'thread_id': 'quality-policy'}}\n",
    "policy_first = policy_quality_app.invoke(initial_state('ì–´ì œ í™˜ë¶ˆì„ ìš”ì²­í–ˆëŠ”ë° ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ì–´ìš”.'), config=policy_config)\n",
    "print('[ì •ì±… ë¬¸ì˜ - ì¸í„°ëŸ½íŠ¸ ë°œìƒ]')\n",
    "print(policy_first['__interrupt__'])\n",
    "\n",
    "policy_resume = Command(resume='í™˜ë¶ˆ ìŠ¹ì¸ ì™„ë£Œ. ì²˜ë¦¬ ê¸°ê°„ì€ ì˜ì—…ì¼ ê¸°ì¤€ 7ì¼ì…ë‹ˆë‹¤.')\n",
    "policy_second = policy_quality_app.invoke(policy_resume, config=policy_config)\n",
    "print('\n",
    "[ì •ì±… ë¬¸ì˜ - ê²€í†  í›„ ìµœì¢… ì‘ë‹µ]')\n",
    "print(policy_second['final_response'])\n",
    "print('ì‹¤í–‰ ë¡œê·¸:', policy_second['audit_log'])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d598509e",
   "metadata": {},
   "source": [
    "## Step 6. ì „ì²´ ê·¸ë˜í”„ ì¡°ë¦½\n",
    "ì•ì—ì„œ ë§Œë“  ë…¸ë“œë¥¼ LangGraph `StateGraph`ì— ë“±ë¡í•˜ê³  ì˜ì¡´ ê´€ê³„ë¥¼ ì—£ì§€ë¡œ í‘œí˜„í•©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8ed6da35",
   "metadata": {},
   "outputs": [],
   "source": [
    "full_graph = StateGraph(IntegratedState)\n",
    "full_graph.add_node('router', router_node)\n",
    "full_graph.add_node('technical_team', technical_team_node)\n",
    "full_graph.add_node('policy_team', policy_team_node)\n",
    "full_graph.add_node('service_team', service_team_node)\n",
    "full_graph.add_node('fan_in', fan_in_node)\n",
    "full_graph.add_node('quality_gate', quality_gate_node)\n",
    "full_graph.add_node('human_review', human_review_node)\n",
    "full_graph.add_node('writer_signoff', writer_signoff_node)\n",
    "\n",
    "full_graph.add_edge(START, 'router')\n",
    "full_graph.add_edge('router', 'technical_team')\n",
    "full_graph.add_edge('router', 'policy_team')\n",
    "full_graph.add_edge('router', 'service_team')\n",
    "full_graph.add_edge('technical_team', 'fan_in')\n",
    "full_graph.add_edge('policy_team', 'fan_in')\n",
    "full_graph.add_edge('service_team', 'fan_in')\n",
    "full_graph.add_edge('fan_in', 'quality_gate')\n",
    "full_graph.add_edge('quality_gate', 'human_review')\n",
    "full_graph.add_edge('quality_gate', 'writer_signoff')\n",
    "full_graph.add_edge('human_review', 'writer_signoff')\n",
    "full_graph.add_edge('writer_signoff', END)\n",
    "\n",
    "full_app = full_graph.compile(checkpointer=MemorySaver())\n",
    "print('Graph compiled.')\n",
    "visualize_graph(full_app)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "347fa405",
   "metadata": {},
   "outputs": [],
   "source": [
    "print('[ì „ì²´ ê·¸ë˜í”„ - ìë™ ìŠ¹ì¸ ê²½ë¡œ]')\n",
    "auto_config = {'configurable': {'thread_id': 'auto-demo'}}\n",
    "auto_result = full_app.invoke(initial_state('ì¶©ì „ê¸°ê°€ ê³ ì¥ë‚˜ì„œ ë„ì›€ì´ í•„ìš”í•´ìš”'), config=auto_config)\n",
    "print(auto_result['final_response'])\n",
    "print('\n",
    "ì‹¤í–‰ ë¡œê·¸:')\n",
    "for step in auto_result['audit_log']:\n",
    "    print('-', step)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e08306ef",
   "metadata": {},
   "source": [
    "### Step 6 ê²°ê³¼ í•´ì„\n",
    "- ìµœì¢… ì‘ë‹µì€ ì„¸ íŒ€ ë³´ê³ ì„œë¥¼ í•œê¸€ë¡œ í†µí•©í•´ ì œê³µí•©ë‹ˆë‹¤.\n",
    "- ì‹¤í–‰ ë¡œê·¸ëŠ” ë¼ìš°íŒ… â†’ ë³´ê³ ì„œ ì‘ì„± â†’ ì´ˆì•ˆ êµ¬ì„± â†’ í’ˆì§ˆ ê°€ë“œ í†µê³¼ â†’ ìµœì¢… ì‚¬ì¸ì˜¤í”„ ìˆœìœ¼ë¡œ ìŒ“ì…ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a78f4cb4",
   "metadata": {},
   "outputs": [],
   "source": [
    "print('[ì „ì²´ ê·¸ë˜í”„ - ì¸ê°„ ê²€í†  ê²½ë¡œ]')\n",
    "policy_config = {'configurable': {'thread_id': 'policy-case'}}\n",
    "policy_first = full_app.invoke(initial_state('ì–´ì œ í™˜ë¶ˆì„ ìš”ì²­í–ˆëŠ”ë° ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ì–´ìš”.'), config=policy_config)\n",
    "print('ì¸í„°ëŸ½íŠ¸ í˜ì´ë¡œë“œ:')\n",
    "print(policy_first['__interrupt__'])\n",
    "\n",
    "policy_second = full_app.invoke(Command(resume='í™˜ë¶ˆ ìŠ¹ì¸ ì™„ë£Œ. ì²˜ë¦¬ ê¸°ê°„ì€ ì˜ì—…ì¼ ê¸°ì¤€ 7ì¼ì…ë‹ˆë‹¤.'), config=policy_config)\n",
    "print('\n",
    "ê²€í†  í›„ ìµœì¢… ì‘ë‹µ:')\n",
    "print(policy_second['final_response'])\n",
    "print('\n",
    "ì‹¤í–‰ ë¡œê·¸:')\n",
    "for step in policy_second['audit_log']:\n",
    "    print('-', step)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "adead640",
   "metadata": {},
   "source": [
    "### Step 7 ê²°ê³¼ í•´ì„\n",
    "- ì •ì±… ë¬¸ì˜ì—ì„œëŠ” ì¸í„°ëŸ½íŠ¸ í˜ì´ë¡œë“œë¥¼ í†µí•´ ì´ˆì•ˆê³¼ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ê²€í† ìì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.\n",
    "- `Command(resume=â€¦)`ë¡œ ì¬ê°œí•˜ë©´ ê²€í† ì ë©”ëª¨ê°€ í¬í•¨ëœ ìµœì¢… ì‘ë‹µì´ ìƒì„±ë˜ê³ , ì‹¤í–‰ ë¡œê·¸ì— `ì¸ê°„ ê²€í†  ìš”ì²­ â†’ ê²€í†  í”¼ë“œë°± ë°˜ì˜ â†’ ìµœì¢… ì‚¬ì¸ì˜¤í”„` ìˆœì„œê°€ ê¸°ë¡ë©ë‹ˆë‹¤."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
